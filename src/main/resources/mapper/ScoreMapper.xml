<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.student.mapper.ScoreMapper">

    <!-- 结果映射 -->
    <resultMap id="ScoreResultMap" type="com.student.entity.Score">
        <id column="id" property="id"/>
        <result column="student_id" property="studentId"/>
        <result column="course_id" property="courseId"/>
        <result column="score" property="score"/>
        <result column="grade_point" property="gradePoint"/>
        <result column="exam_type" property="examType"/>
        <result column="semester" property="semester"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_time" property="updatedTime"/>
        <!-- 关联学生信息 -->
        <association property="student" javaType="com.student.entity.Student">
            <id column="student_id" property="id"/>
            <result column="student_no" property="studentNo"/>
            <result column="student_name" property="name"/>
            <result column="student_major" property="major"/>
            <result column="student_class" property="className"/>
        </association>
        <!-- 关联课程信息 -->
        <association property="course" javaType="com.student.entity.Course">
            <id column="course_id" property="id"/>
            <result column="course_code" property="courseCode"/>
            <result column="course_name" property="courseName"/>
            <result column="course_credits" property="credits"/>
            <result column="course_teacher" property="teacher"/>
        </association>
    </resultMap>

    <!-- 根据ID查询成绩 -->
    <select id="findById" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.id = #{id}
    </select>

    <!-- 根据学生ID和课程ID查询成绩 -->
    <select id="findByStudentAndCourse" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.student_id = #{studentId} AND s.course_id = #{courseId}
    </select>

    <!-- 查询所有成绩 -->
    <select id="findAll" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        ORDER BY s.created_time DESC
    </select>

    <!-- 分页查询成绩 -->
    <select id="findByPage" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        ORDER BY s.created_time DESC LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据学生ID查询成绩 -->
    <select id="findByStudentId" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.student_id = #{studentId}
        ORDER BY s.created_time DESC
    </select>

    <!-- 根据课程ID查询成绩 -->
    <select id="findByCourseId" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.course_id = #{courseId}
        ORDER BY s.created_time DESC
    </select>

    <!-- 根据学期查询成绩 -->
    <select id="findBySemester" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.semester = #{semester}
        ORDER BY s.created_time DESC
    </select>

    <!-- 根据考试类型查询成绩 -->
    <select id="findByExamType" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.exam_type = #{examType}
        ORDER BY s.created_time DESC
    </select>

    <!-- 多条件查询成绩 -->
    <select id="findByConditions" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        <where>
            <if test="studentId != null">
                AND s.student_id = #{studentId}
            </if>
            <if test="courseId != null">
                AND s.course_id = #{courseId}
            </if>
            <if test="semester != null and semester != ''">
                AND s.semester = #{semester}
            </if>
            <if test="examType != null and examType != ''">
                AND s.exam_type = #{examType}
            </if>
        </where>
        ORDER BY s.created_time DESC
    </select>

    <!-- 查询学生成绩统计信息 -->
    <select id="findStudentScoreStats" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.student_id = #{studentId}
        ORDER BY s.semester DESC, c.course_name
    </select>

    <!-- 查询课程成绩统计信息 -->
    <select id="findCourseScoreStats" resultMap="ScoreResultMap">
        SELECT s.*, st.student_no, st.name as student_name, st.major as student_major, st.class_name as student_class,
               c.course_code, c.course_name, c.credits as course_credits, c.teacher as course_teacher
        FROM scores s
        LEFT JOIN students st ON s.student_id = st.id
        LEFT JOIN courses c ON s.course_id = c.id
        WHERE s.course_id = #{courseId}
        ORDER BY s.score DESC
    </select>

    <!-- 统计成绩总数 -->
    <select id="countAll" resultType="int">
        SELECT COUNT(*) FROM scores
    </select>

    <!-- 根据条件统计成绩数量 -->
    <select id="countByConditions" resultType="int">
        SELECT COUNT(*) FROM scores
        <where>
            <if test="studentId != null">
                AND student_id = #{studentId}
            </if>
            <if test="courseId != null">
                AND course_id = #{courseId}
            </if>
            <if test="semester != null and semester != ''">
                AND semester = #{semester}
            </if>
            <if test="examType != null and examType != ''">
                AND exam_type = #{examType}
            </if>
        </where>
    </select>

    <!-- 插入成绩 -->
    <insert id="insert" parameterType="com.student.entity.Score" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO scores (student_id, course_id, score, grade_point, exam_type, semester)
        VALUES (#{studentId}, #{courseId}, #{score}, #{gradePoint}, #{examType}, #{semester})
    </insert>

    <!-- 更新成绩 -->
    <update id="update" parameterType="com.student.entity.Score">
        UPDATE scores SET
            student_id = #{studentId},
            course_id = #{courseId},
            score = #{score},
            grade_point = #{gradePoint},
            exam_type = #{examType},
            semester = #{semester},
            updated_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 根据ID删除成绩 -->
    <delete id="deleteById">
        DELETE FROM scores WHERE id = #{id}
    </delete>

    <!-- 根据学生ID删除成绩 -->
    <delete id="deleteByStudentId">
        DELETE FROM scores WHERE student_id = #{studentId}
    </delete>

    <!-- 根据课程ID删除成绩 -->
    <delete id="deleteByCourseId">
        DELETE FROM scores WHERE course_id = #{courseId}
    </delete>

    <!-- 批量删除成绩 -->
    <delete id="deleteByIds">
        DELETE FROM scores WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>
